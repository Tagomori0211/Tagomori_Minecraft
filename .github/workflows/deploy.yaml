name: Deploy Minecraft Dashboard (Hybrid On-Premise)

on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [new-minecraft-backup]

jobs:
  deploy_on_premise:
    runs-on: [self-hosted, Linux] 
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # --- æ—¢å­˜ã®Dockerãƒ‡ãƒ—ãƒ­ã‚¤ ---
    - name: Create .env file
      run: |
        echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
        echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
        echo "FLASK_APP_SECRET_KEY=${{ secrets.FLASK_APP_SECRET_KEY }}" >> .env
        echo "DUCKDNS_TOKEN=${{ secrets.DUCKDNS_TOKEN }}" >> .env

    - name: Build and Deploy Dashboard (Docker)
      run: |
        docker compose up -d --build --remove-orphans
        docker image prune -f

    # --- ã€è¿½åŠ ã€‘K3sã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ ---
    # DevOps VMã®Runnerã‹ã‚‰ã€MCBE VMã®K3sã‚’æ“ä½œã™ã‚‹
    - name: Deploy to K3s (Minecraft Server)
      env:
        # GitHub Secretsã«ç™»éŒ²ã—ãŸ kubeconfig ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      run: |
        # 1. kubectl ãƒ„ãƒ¼ãƒ«ã®èª¿é” (Runnerã«ãªã„å ´åˆã‚’æƒ³å®šã—ã¦DLã™ã‚‹)
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        
        # 2. .kubeãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ & è¨­å®šé…ç½®
        mkdir -p ~/.kube
        echo "$KUBE_CONFIG_DATA" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config
        
        # 3. cAdvisorã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’é©ç”¨ï¼ (./kubectl ã§å®Ÿè¡Œ)
        echo "ğŸš€ Applying cAdvisor manifest to K3s..."
        ./kubectl apply -f MCBEs/cadvisor.yaml
        ./kubectl apply -f MCBEs/minecraft.yaml
        
        # 4. è¨­å®šå¤‰æ›´ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚Podã‚’å†ä½œæˆ
        ./kubectl delete pods -l app=cadvisor --ignore-not-found=true
        ./kubectl delete pods -l app=minecraft-bedrock --ignore-not-found=true