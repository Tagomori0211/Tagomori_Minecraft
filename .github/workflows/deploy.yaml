name: Deploy Minecraft Dashboard (Hybrid On-Premise)

on:
  push:
    branches:
      - main
  repository_dispatch:
    types: [new-minecraft-backup]

jobs:
  deploy_on_premise:
    # ここで自宅サーバーのランナーを指定！
    runs-on: [self-hosted, Linux] 
    steps:
    # 1. 自宅サーバー内にコードを持​​ってくる
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 環境変数のセットアップ (.envファイルを作成)
    # GitHubの Secrets に登録したパスワードなどを、サーバー内の .env ファイルに書き出す
    - name: Create .env file
      run: |
        echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
        echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
        echo "POSTGRES_DB=${{ secrets.POSTGRES_DB }}" >> .env
        # その他の環境変数も必要ならここに追加

    # 3. Docker Compose でビルド & 起動 (全部ローカルで完結！)
    # レジストリへのPush/Pull時間をゼロにする「ローカルビルド戦略」
    - name: Build and Deploy locally
      run: |
        # キャッシュを効かせずに再ビルドして起動
        docker compose up -d --build --remove-orphans
        
        # 古いイメージのお掃除 (ディスク圧迫防止)
        docker image prune -f

    # 4. データ取り込み処理 (バックアップ検知時のみ)
    - name: Trigger data ingestion
      if: github.event_name == 'repository_dispatch' && github.event.action == 'new-minecraft-backup'
      run: |
        # Parserコンテナを一回だけ実行して終了する
        docker-compose run --rm parser python /app/parse_and_ingest.py