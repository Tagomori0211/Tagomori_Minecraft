# ---------------------------------------------------------
# 1. ConfigMap: è¨­å®šå€¤ (Environment Variables)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-config
  namespace: default
data:
  # ç’°å¢ƒã«åˆã‚ã›ã¦ã“ã“ã ã‘å¤‰ãˆã‚Œã°OKï¼
  TARGET_IP: "192.168.0.21"        # VM1 (DevOps) ã®IP
  TARGET_USER: "tagomori"          # SSHãƒ¦ãƒ¼ã‚¶ãƒ¼
  TARGET_DIR: "/minecraft_backups" #è»¢é€å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

---
# ---------------------------------------------------------
# 2. ConfigMap: ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ¬ä½“ (Logic)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: default
data:
  backup.sh: |
    #!/bin/sh
    set -e # ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰å³åœæ­¢

    echo "ğŸ”§ Setting up SSH..."
    mkdir -p ~/.ssh
    cp /etc/secret-volume/id_rsa ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    echo "StrictHostKeyChecking no" >> ~/.ssh/config

    echo "ğŸ“¦ Compressing data..."
    # æ—¥ä»˜å…¥ã‚Šãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
    FILENAME="world_backup_$(date +%Y%m%d-%H%M).tar.gz"
    
    # /data é…ä¸‹ã‚’åœ§ç¸® (/tmpã«ã¦ä½œæ¥­)
    tar -czf /tmp/$FILENAME -C /data .

    echo "ğŸšš Transferring to ${TARGET_USER}@${TARGET_IP}:${TARGET_DIR} ..."
    
    # ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ã£ã¦è»¢é€
    scp -i ~/.ssh/id_rsa /tmp/$FILENAME ${TARGET_USER}@${TARGET_IP}:${TARGET_DIR}/$FILENAME

    echo "âœ… Backup job finished successfully!"

---
# ---------------------------------------------------------
# 3. CronJob: å®Ÿè¡Œå®šç¾© (Execution)
# ---------------------------------------------------------
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-exporter
  namespace: default
spec:
  schedule: "0 5 * * *" # æ¯æ—¥ 05:00
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup-worker
              image: alpine:latest
              command: ["/bin/sh", "/scripts/backup.sh"] # ãƒã‚¦ãƒ³ãƒˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
              
              # ã€é‡è¦ã€‘ConfigMapã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’ä¸€æ‹¬æ³¨å…¥
              envFrom:
                - configMapRef:
                    name: backup-config
              
              volumeMounts:
                - name: data-volume
                  mountPath: /data
                  readOnly: true
                - name: ssh-key-volume
                  mountPath: /etc/secret-volume
                  readOnly: true
                - name: script-volume
                  mountPath: /scripts
                  readOnly: true

          volumes:
            - name: data-volume
              hostPath:
                path: /data/minecraft
                type: Directory
            - name: ssh-key-volume
              secret:
                secretName: ssh-key-secret
            - name: script-volume
              configMap:
                name: backup-script
                defaultMode: 0755 # å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸

          restartPolicy: OnFailure