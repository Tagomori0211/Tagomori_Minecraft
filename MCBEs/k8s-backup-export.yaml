# ---------------------------------------------------------
# 1. ConfigMap: è¨­å®šå€¤ (Environment Variables)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-config
  namespace: default
data:
  # ç’°å¢ƒã«åˆã‚ã›ã¦ã“ã“ã ã‘å¤‰ãˆã‚Œã°OKï¼
  TARGET_IP: "192.168.0.21"        # VM1 (DevOps) ã®IP
  TARGET_USER: "tagomori"          # SSHãƒ¦ãƒ¼ã‚¶ãƒ¼
  TARGET_DIR: "/home/tagomori/MinecraftBE_and_Resouce_Monitor/minecraft_backups"
---
# ---------------------------------------------------------
# 2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ¬ä½“ (ConfigMap)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: default
data:
  backup.sh: |
    #!/bin/sh
    set -e # ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰å³åœæ­¢

    echo "ğŸ”§ Installing tools..."
    # scpã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ãŸã‚ã« openssh-client ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    apk add --no-cache openssh-client tar gzip

    echo "ğŸ”§ Setting up SSH..."
    mkdir -p ~/.ssh
    # Secretã‹ã‚‰ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸéµã‚’ã‚³ãƒ”ãƒ¼
    cp /etc/secret-volume/id_rsa ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    # åˆå›æ¥ç¶šæ™‚ã®ç¢ºèªã‚’ç„¡è¦–ã™ã‚‹è¨­å®š
    echo "StrictHostKeyChecking no" >> ~/.ssh/config

    echo "ğŸ“¦ Compressing data..."
    # æ—¥ä»˜å…¥ã‚Šãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ (YYYYMMDD-HHMM)
    FILENAME="world_backup_$(date +%Y%m%d-%H%M).tar.gz"
    
    # /data é…ä¸‹ã‚’åœ§ç¸® (/tmpã«ã¦ä½œæ¥­)
    # â€» mc-monitor ç­‰ã®ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã¦ã‚‚è‰¯ã„ãŒã€ä¸€æ—¦ä¸¸ã”ã¨åœ§ç¸®
    tar -czf /tmp/$FILENAME -C /data .

    echo "ğŸšš Transferring to ${TARGET_USER}@${TARGET_IP}:${TARGET_DIR} ..."
    
    # è»¢é€å®Ÿè¡Œ
    scp -i ~/.ssh/id_rsa /tmp/$FILENAME ${TARGET_USER}@${TARGET_IP}:${TARGET_DIR}/$FILENAME

    echo "âœ… Backup job finished successfully!"

---
# ---------------------------------------------------------
# 3. CronJob (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ)
# ---------------------------------------------------------
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-exporter
  namespace: default
spec:
  # ã€é‡è¦ã€‘æ—¥æœ¬æ™‚é–“ã§å®Ÿè¡Œ
  timeZone: "Asia/Tokyo"
  schedule: "0 5 * * *" # æ¯æ—¥ æœ5:00 (JST)
  
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup-worker
              image: alpine:latest
              command: ["/bin/sh", "/scripts/backup.sh"]
              
              envFrom:
                - configMapRef:
                    name: backup-config
              
              volumeMounts:
                - name: data-volume
                  mountPath: /data
                  readOnly: true # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã®ã§èª­ã¿å–ã‚Šå°‚ç”¨ã§å®‰å…¨ã«
                - name: ssh-key-volume
                  mountPath: /etc/secret-volume
                  readOnly: true
                - name: script-volume
                  mountPath: /scripts
                  readOnly: true

          volumes:
            - name: data-volume
              hostPath:
                path: /data/minecraft
                type: Directory
            - name: ssh-key-volume
              secret:
                # ã€é‡è¦ã€‘ã“ã®SecretãŒK3sã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼
                secretName: ssh-key-secret
            - name: script-volume
              configMap:
                name: backup-script
                defaultMode: 0755

          restartPolicy: OnFailure