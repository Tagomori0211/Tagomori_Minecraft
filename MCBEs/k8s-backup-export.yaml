# ---------------------------------------------------------
# 1. ConfigMap: è¨­å®šå€¤ (Environment Variables)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-config
  namespace: default
data:
  TARGET_IP: "192.168.0.21"
  TARGET_USER: "tagomori"
  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ•ãƒ«ãƒ‘ã‚¹
  TARGET_DIR: "/home/tagomori/MinecraftBE_and_Resouce_Monitor/minecraft_backups/"

---
# ---------------------------------------------------------
# 2. ã‚¹ã‚¯ãƒªãƒ—ãƒˆæœ¬ä½“ (ConfigMap)
# ---------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-script
  namespace: default
data:
  backup.sh: |
    #!/bin/sh
    set -e # ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚‰å³åœæ­¢

    echo "ğŸ”§ Installing tools..."
    # ã€è¿½åŠ ã€‘tzdata (ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ãƒ‡ãƒ¼ã‚¿) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    apk add --no-cache openssh-client tar gzip tzdata

    # ã€é‡è¦ã€‘ã‚³ãƒ³ãƒ†ãƒŠå†…ã®æ™‚é–“ã‚’JSTã«è¨­å®š
    export TZ=Asia/Tokyo
    echo "ğŸ•’ Current Time (JST): $(date)"

    echo "ğŸ”§ Setting up SSH..."
    mkdir -p ~/.ssh
    cp /etc/secret-volume/id_rsa ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    echo "StrictHostKeyChecking no" >> ~/.ssh/config

    echo "ğŸ“¦ Compressing data..."
    # ã€ä¿®æ­£ã€‘æ—¥ä»˜ã®ã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«å (YYYYMMDD)
    FILENAME="world_backup_$(date +%Y%m%d).tar.gz"
    
    # /data é…ä¸‹ã‚’åœ§ç¸®
    tar -czf /tmp/$FILENAME -C /data .

    echo "ğŸšš Transferring to ${TARGET_USER}@${TARGET_IP}:${TARGET_DIR} ..."
    
    scp -i ~/.ssh/id_rsa /tmp/$FILENAME ${TARGET_USER}@${TARGET_IP}:${TARGET_DIR}/$FILENAME

    echo "âœ… Backup job finished successfully!"

---
# ---------------------------------------------------------
# 3. CronJob (ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ)
# ---------------------------------------------------------
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-exporter
  namespace: default
spec:
  # ãƒˆãƒªã‚¬ãƒ¼ã®æ™‚é–“ã‚’JSTåŸºæº–ã«ã™ã‚‹
  timeZone: "Asia/Tokyo"
  schedule: "0 5 * * *" # æ¯æ—¥ æœ5:00 (JST)
  
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup-worker
              image: alpine:latest
              command: ["/bin/sh", "/scripts/backup.sh"]
              
              envFrom:
                - configMapRef:
                    name: backup-config
              
              volumeMounts:
                - name: data-volume
                  mountPath: /data
                  readOnly: true
                - name: ssh-key-volume
                  mountPath: /etc/secret-volume
                  readOnly: true
                - name: script-volume
                  mountPath: /scripts
                  readOnly: true

          volumes:
            - name: data-volume
              hostPath:
                path: /data/minecraft
                type: Directory
            - name: ssh-key-volume
              secret:
                secretName: ssh-key-secret
            - name: script-volume
              configMap:
                name: backup-script
                defaultMode: 0755

          restartPolicy: OnFailure