# ---------------------------------------------------------
# 1. PersistentVolumeClaim (データの保存場所)
# ---------------------------------------------------------
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mc-bedrock-data
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi # 余裕を持って10GB

---
# ---------------------------------------------------------
# 2. Service (外部への公開設定)
# ---------------------------------------------------------
apiVersion: v1
kind: Service
metadata:
  name: mc-bedrock-svc
spec:
  type: NodePort
  selector:
    app: minecraft-bedrock
  ports:
    - name: bedrock-udp
      protocol: UDP
      port: 19134        # サービス側の受付ポート
      targetPort: 19134  # コンテナへの転送先
      nodePort: 30000    # 外部公開ポート (ルーター設定用)

---
# ---------------------------------------------------------
# 3. Deployment (サーバー本体の設定)
# ---------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mc-bedrock
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: minecraft-bedrock
  template:
    metadata:
      labels:
        app: minecraft-bedrock
    spec:
      containers:
        - name: minecraft
          image: itzg/minecraft-bedrock-server:latest
          imagePullPolicy: Always
          tty: true
          stdin: true

          # ==========================================
          # 【修正1】 ポート設定 (穴を開ける設定)
          # ==========================================
          ports:
            # メインのゲームポート (IPv4)
            - containerPort: 19134
              protocol: UDP
              name: bedrock-udp
            
            # RCON用ポート
            - containerPort: 4711
              protocol: TCP
              name: rcon-tcp

          resources:
            requests:
              memory: "1Gi"
            limits:
              memory: "4Gi"
          
          # ==========================================
          # 【修正2】 環境変数 (ソフトへの設定値)
          # ==========================================
          env:
            - name: EULA
              value: "TRUE"
            
            # IPv4ポート設定 (19133から変更)
            - name: SERVER_PORT
              value: "19134"

            # IPv6ポート設定 (IPv4との衝突回避用)
            - name: SERVER_PORT_V6
              value: "19135"

            # RCON設定
            - name: ENABLE_RCON
              value: "true"
            - name: RCON_PASSWORD
              value: "minecraft"

          # データマウント設定
          volumeMounts:
            - name: data-volume
              mountPath: /data
      
      # ボリュームの定義 (HostPathでオンプレミスのデータを直接参照)
      volumes:
        - name: data-volume
          hostPath:
            path: /data/minecraft
            type: Directory